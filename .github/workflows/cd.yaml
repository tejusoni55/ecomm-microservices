name: Deploy changed services to ECS (Pulumi)

on:
  workflow_run:
    workflows: ["Build & Push Changed Services to ECR"] # name of previous workflow
    types:
      - completed

permissions:
  contents: read

concurrency:
  group: deploy-changed-to-ecs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changed:
    name: Detect changed services (paths-filter)
    runs-on: ubuntu-latest
    outputs:
      users: ${{ steps.filter.outputs.users }}
      products: ${{ steps.filter.outputs.products }}
      orders: ${{ steps.filter.outputs.orders }}
      notifications: ${{ steps.filter.outputs.notifications }}
      payments: ${{ steps.filter.outputs.payments }}
      envoy: ${{ steps.filter.outputs.envoy }}
      infra_configs: ${{ steps.filter.outputs.infra_configs }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: filter
        name: Detect changed services (paths-filter)
        uses: dorny/paths-filter@v3
        with:
          # Each filter key becomes an output e.g. steps.changed.outputs.users == 'true'
          filters: |
            users:
              - 'services/users/**'
              - 'services/users/*'
              - 'services/users/Dockerfile'
            orders:
              - 'services/orders/**'
              - 'services/orders/*'
              - 'services/orders/Dockerfile'
            products:
              - 'services/products/**'
              - 'services/products/*'
              - 'services/products/Dockerfile'
            notifications:
              - 'services/notifications/**'
              - 'services/notifications/*'
              - 'services/notifications/Dockerfile'
            payments:
              - 'services/payments/**'
              - 'services/payments/*'
              - 'services/payments/Dockerfile'
            envoy:
              - 'infra/envoy/**'
              - 'infra/envoy/Dockerfile'
            # other infra/config changes that should trigger builds for all services
            infra_configs:
              - 'infra/kafka/**'
              - 'infra/otel-collector/**'
              - 'libs/**'
              - '.github/workflows/**'
              - 'package.json'
              - 'pnpm-lock.yaml'

  pulumi-deploy:
    name: Pulumi deploy changed services
    runs-on: ubuntu-latest
    needs: detect-changed
    if: |
      needs.detect-changed.outputs.users == 'true' ||
      needs.detect-changed.outputs.products == 'true' ||
      needs.detect-changed.outputs.orders == 'true' ||
      needs.detect-changed.outputs.notifications == 'true' ||
      needs.detect-changed.outputs.payments == 'true' ||
      needs.detect-changed.outputs.envoy == 'true' ||
      needs.detect-changed.outputs.infra_configs == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install Pulumi CLI
        run: curl -fsSL https://get.pulumi.com | sh && echo "PATH=$PATH:$HOME/.pulumi/bin" >> $GITHUB_PATH

      - name: Pulumi login
        uses: pulumi/actions-login@v2
        with:
          access-token: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Set images in Pulumi config for changed services
        id: set-images
        run: |
          cd infra/pulumi
          pulumi stack select ${{ secrets.PULUMI_STACK }}

          # Helper function: set if changed
          set_if_changed() {
            svc_key=$1       # short key in pulumi images map (e.g. users)
            repo_name=$2     # ecr repo name (ecomm-users-service)
            changed=$3       # 'true'/'false' from detector
            if [ "$changed" = "true" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ needs.detect-changed.outputs.infra_configs }}" = "true" ]; then
              image="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${repo_name}:latest"
              echo "Setting pulumi config images.${svc_key} = ${image}"
              pulumi config set --path images.${svc_key} "${image}"
            else
              echo "Not changed: ${svc_key}"
            fi
          }

          set_if_changed users-service ecomm-users-service "${{ needs.detect-changed.outputs.users }}"
          set_if_changed products-service ecomm-products-service "${{ needs.detect-changed.outputs.products }}"
          set_if_changed orders-service ecomm-orders-service "${{ needs.detect-changed.outputs.orders }}"
          set_if_changed notifications-service ecomm-notifications-service "${{ needs.detect-changed.outputs.notifications }}"
          set_if_changed payments-service ecomm-payments-service "${{ needs.detect-changed.outputs.payments }}"
          set_if_changed envoy ecomm-envoy "${{ needs.detect-changed.outputs.envoy }}"

      - name: Pulumi up (auto-approve)
        run: |
          cd infra/pulumi
          pulumi up --yes
