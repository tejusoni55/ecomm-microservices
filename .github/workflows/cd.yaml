name: Deploy changed services to ECS (Pulumi)

on:
  repository_dispatch:
    types: [deploy-ecs-services]

permissions:
  contents: read

concurrency:
  group: deploy-changed-to-ecs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pulumi-deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Print incoming repository_dispatch payload (debug)
        run: |
          echo "Event name: $GITHUB_EVENT_NAME"
          echo "Event file: $GITHUB_EVENT_PATH"
          echo "---- payload ----"
          sed -n '1,200p' "$GITHUB_EVENT_PATH" || true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Pulumi login
        uses: pulumi/actions@v6
        with:
          access-token: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Ensure jq is available (JSON tool)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Parse services from dispatch payload & set Pulumi image config
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          PULUMI_STACK: ${{ secrets.PULUMI_STACK }}
        run: |
          set -euo pipefail

          # Read services array from repository_dispatch client_payload
          # Use $GITHUB_EVENT_PATH (file that GitHub populates)
          services_json=$(jq -c '.client_payload.services // .services // []' "$GITHUB_EVENT_PATH")
          echo "services_json=$services_json"

          if [ "$services_json" = "[]" ]; then
            echo "No services found in client_payload.services â€” nothing to deploy."
            exit 0
          fi

          cd infra/pulumi

          # select stack (must exist)
          pulumi stack select "${{ secrets.PULUMI_STACK }}"

          # iterate each service object and set pulumi config images.<service-name> to ECR image:latest
          # we use the 'name' field as the pulumi key
          echo "$services_json" | jq -c '.[]' | while read -r svc; do
            svc_name=$(echo "$svc" | jq -r '.name')
            repo_name=$(echo "$svc" | jq -r '.image_repo')

            if [ -z "$svc_name" ] || [ "$svc_name" = "null" ]; then
              echo "Skipping invalid service entry: $svc"
              continue
            fi

            image_uri="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${repo_name}:latest"
            echo "Setting Pulumi config images.${svc_name} = ${image_uri}"
            # Use --path so nested keys work: images.<svc_name>
            pulumi config set --path "images.${svc_name}" "${image_uri}"
          done

      - name: Pulumi up (auto-approve)
        working-directory: infra/pulumi
        run: |
          pulumi up --yes
